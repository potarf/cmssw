layer_to_depth = {}
#layer, eta = depth
layer_to_depth[3, 16] = 2
layer_to_depth[4, 16] = 2
layer_to_depth[5, 16] = 2
layer_to_depth[6, 16] = 2
layer_to_depth[7, 16] = 3
layer_to_depth[8, 16] = 3

layer_to_depth[0, 17] = 2
layer_to_depth[1, 17] = 2
layer_to_depth[2, 17] = 2
layer_to_depth[3, 17] = 3
layer_to_depth[4, 17] = 3
layer_to_depth[5, 17] = 3
layer_to_depth[6, 17] = 3
layer_to_depth[7, 17] = 4
layer_to_depth[8, 17] = 4
layer_to_depth[9, 17] = 4
layer_to_depth[10, 17] = 5
layer_to_depth[11, 17] = 5
layer_to_depth[12, 17] = 5
layer_to_depth[13, 17] = 5

layer_to_depth[0, 18] = 1
layer_to_depth[1, 18] = 2
layer_to_depth[2, 18] = 2
layer_to_depth[3, 18] = 2
layer_to_depth[4, 18] = 3
layer_to_depth[5, 18] = 3
layer_to_depth[6, 18] = 3
layer_to_depth[7, 18] = 4
layer_to_depth[8, 18] = 4
layer_to_depth[9, 18] = 4
layer_to_depth[10, 18] = 5
layer_to_depth[11, 18] = 5
layer_to_depth[12, 18] = 5
layer_to_depth[13, 18] = 5
layer_to_depth[14, 18] = 6
layer_to_depth[15, 18] = 6

layer_to_depth[0, 19] = 1
layer_to_depth[1, 19] = 2
layer_to_depth[2, 19] = 2
layer_to_depth[3, 19] = 2
layer_to_depth[4, 19] = 3
layer_to_depth[5, 19] = 3
layer_to_depth[6, 19] = 3
layer_to_depth[7, 19] = 4
layer_to_depth[8, 19] = 4
layer_to_depth[9, 19] = 4
layer_to_depth[10, 19] = 5
layer_to_depth[11, 19] = 5
layer_to_depth[12, 19] = 5
layer_to_depth[13, 19] = 5
layer_to_depth[14, 19] = 6
layer_to_depth[15, 19] = 6
layer_to_depth[16, 19] = 6

layer_to_depth[0, 20] = 1
layer_to_depth[1, 20] = 2
layer_to_depth[2, 20] = 2
layer_to_depth[3, 20] = 2
layer_to_depth[4, 20] = 3
layer_to_depth[5, 20] = 3
layer_to_depth[6, 20] = 3
layer_to_depth[7, 20] = 4
layer_to_depth[8, 20] = 4
layer_to_depth[9, 20] = 4
layer_to_depth[10, 20] = 5
layer_to_depth[11, 20] = 5
layer_to_depth[12, 20] = 5
layer_to_depth[13, 20] = 5
layer_to_depth[14, 20] = 6
layer_to_depth[15, 20] = 6
layer_to_depth[16, 20] = 6

layer_to_depth[0, 21] = 1
layer_to_depth[1, 21] = 2
layer_to_depth[2, 21] = 2
layer_to_depth[3, 21] = 2
layer_to_depth[4, 21] = 3
layer_to_depth[5, 21] = 3
layer_to_depth[6, 21] = 3
layer_to_depth[7, 21] = 4
layer_to_depth[8, 21] = 4
layer_to_depth[9, 21] = 4
layer_to_depth[10, 21] = 5
layer_to_depth[11, 21] = 5
layer_to_depth[12, 21] = 5
layer_to_depth[13, 21] = 5
layer_to_depth[14, 21] = 6
layer_to_depth[15, 21] = 6
layer_to_depth[16, 21] = 6

layer_to_depth[0, 22] = 1
layer_to_depth[1, 22] = 2
layer_to_depth[2, 22] = 2
layer_to_depth[3, 22] = 2
layer_to_depth[4, 22] = 3
layer_to_depth[5, 22] = 3
layer_to_depth[6, 22] = 3
layer_to_depth[7, 22] = 4
layer_to_depth[8, 22] = 4
layer_to_depth[9, 22] = 4
layer_to_depth[10, 22] = 5
layer_to_depth[11, 22] = 5
layer_to_depth[12, 22] = 5
layer_to_depth[13, 22] = 5
layer_to_depth[14, 22] = 6
layer_to_depth[15, 22] = 6
layer_to_depth[16, 22] = 6

layer_to_depth[0, 23] = 1
layer_to_depth[1, 23] = 2
layer_to_depth[2, 23] = 2
layer_to_depth[3, 23] = 3
layer_to_depth[4, 23] = 3
layer_to_depth[5, 23] = 4
layer_to_depth[6, 23] = 4
layer_to_depth[7, 23] = 5
layer_to_depth[8, 23] = 5
layer_to_depth[9, 23] = 5
layer_to_depth[10, 23] = 6
layer_to_depth[11, 23] = 6
layer_to_depth[12, 23] = 6
layer_to_depth[13, 23] = 6
layer_to_depth[14, 23] = 7
layer_to_depth[15, 23] = 7
layer_to_depth[16, 23] = 7

layer_to_depth[0, 24] = 1
layer_to_depth[1, 24] = 2
layer_to_depth[2, 24] = 2
layer_to_depth[3, 24] = 3
layer_to_depth[4, 24] = 3
layer_to_depth[5, 24] = 4
layer_to_depth[6, 24] = 4
layer_to_depth[7, 24] = 5
layer_to_depth[8, 24] = 5
layer_to_depth[9, 24] = 5
layer_to_depth[10, 24] = 6
layer_to_depth[11, 24] = 6
layer_to_depth[12, 24] = 6
layer_to_depth[13, 24] = 6
layer_to_depth[14, 24] = 7
layer_to_depth[15, 24] = 7
layer_to_depth[16, 24] = 7

layer_to_depth[0, 25] = 1
layer_to_depth[1, 25] = 2
layer_to_depth[2, 25] = 2
layer_to_depth[3, 25] = 3
layer_to_depth[4, 25] = 3
layer_to_depth[5, 25] = 4
layer_to_depth[6, 25] = 4
layer_to_depth[7, 25] = 5
layer_to_depth[8, 25] = 5
layer_to_depth[9, 25] = 5
layer_to_depth[10, 25] = 6
layer_to_depth[11, 25] = 6
layer_to_depth[12, 25] = 6
layer_to_depth[13, 25] = 6
layer_to_depth[14, 25] = 7
layer_to_depth[15, 25] = 7
layer_to_depth[16, 25] = 7

depth_to_layers = {}
for layereta, depth in layer_to_depth.iteritems():
    layer, eta = layereta
    if not (depth, eta) in depth_to_layers.keys():
        depth_to_layers[depth, eta] = []
    depth_to_layers[depth, eta].append(layer)

import re
import numpy as np
from pprint import pprint

stops  = [ 0.00, 0.34, 0.61, 0.84, 1.00 ]
red    = [ 0.00, 0.00, 0.87, 1.00, 0.51 ]
green  = [ 0.00, 0.81, 1.00, 0.20, 0.00 ]
blue   = [ 0.51, 1.00, 0.12, 0.00, 0.00 ]

def color1interp(value, colorbin, color):
    return np.interp(value, [stops[colorbin], stops[colorbin + 1]], [color[colorbin], color[colorbin + 1]]) * 255
def color3interp(value, colorbin):
    return (color1interp(value, colorbin, red), color1interp(value, colorbin, green), color1interp(value, colorbin, blue))
def colorInterp(v, minvalue, maxvalue):
    value = np.interp(v, [minvalue, maxvalue], [0.00, 1.00])
    colorbin = 0
    for i in xrange(len(stops) - 1):
        if value < stops[colorbin + 1] and value > stops[colorbin]: break
    return color3interp(value, colorbin)


with open("EVD3274.txt", 'r') as infile:

     head = infile.readline()
     runnum, numevents = head.split()
     runnum = int(runnum)
     numevents = int(numevents)
     outvaluesmap = {
       "runnum" : runnum,
       "numevents" : numevents,
       "events" : {},
       "average" : {},
     }
     eventno = -9
     for line in infile:
         if line[0] != 'i':
             #is an event number
             eventno = int(line)
             outvaluesmap["events"][eventno] = {}

         else:
             matches = re.match('ieta:(.*)_iphi:(.*)_depth:(.*) (.*)', line)
             if matches:
                 ieta = int(matches.group(1))
                 iphi = int(matches.group(2))
                 depth = int(matches.group(3))
                 value = float(matches.group(4))
                 outvaluesmap["events"][eventno][iphi, ieta, depth] = value
                 if (iphi, ieta, depth) in outvaluesmap["average"].keys():
                     outvaluesmap["average"][iphi, ieta, depth] += value

                 else:
                     outvaluesmap["average"][iphi, ieta, depth] = value
     minAv = 0
     maxAv = 0
     for key in outvaluesmap["average"].keys():
         outvaluesmap["average"][key] /= numevents
         iphi, eta, depth = key
         if eta == 22 or eta == 24 or iphi == 5:
             if outvaluesmap["average"][key] > maxAv: maxAv = outvaluesmap["average"][key]
             if outvaluesmap["average"][key] < minAv: minAv = outvaluesmap["average"][key]

     #averages
     etaslayers = {}
     for eta in range(1,30):
         for layer in range(-1,18):
             detector = "he"
             if eta < 17:
                 detector = "hb"
             etaslayers[detector, eta, layer] = (255, 255, 255)

     for key in outvaluesmap["average"].keys():
         iphi, eta, depth = key
         value = outvaluesmap["average"][key]
         if eta == 22 or eta == 24 or iphi == 5:
             if (depth, eta) in depth_to_layers.keys():
                 for layer in depth_to_layers[depth, eta]:
                     etaslayers["he", eta, layer] = colorInterp(value, minAv, maxAv)

     for key in etaslayers.keys():
        detector, eta, layer = key
        rgb = "(%d,%d,%d)" % etaslayers[detector, eta, layer]
        print "%s-%i-%i rgb%s" % (detector, eta, layer, rgb)

